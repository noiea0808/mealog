rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ADMIN 권한 확인 함수
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/artifacts/mealog-r0/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/artifacts/mealog-r0/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // 사용자 본인 확인 함수
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // 인증 확인 함수
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 리소스의 userId가 현재 사용자인지 확인
    function isOwnerOfResource() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // 요청 리소스의 userId가 현재 사용자인지 확인
    function isOwnerOfRequestResource() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // 리소스의 authorId가 현재 사용자인지 확인
    function isAuthorOfResource() {
      return isAuthenticated() && resource.data.authorId == request.auth.uid;
    }
    
    // 요청 리소스의 authorId가 현재 사용자인지 확인
    function isAuthorOfRequestResource() {
      return isAuthenticated() && request.resource.data.authorId == request.auth.uid;
    }
    
    // App Check 토큰 확인 함수 (향후 사용을 위해 추가)
    function hasValidAppCheckToken() {
      return request.appCheck != null && request.appCheck.token != null;
    }
    
    // ============================================
    // 사용자 데이터 (users 컬렉션)
    // ============================================
    match /artifacts/{appId}/users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
      
      // 식사 기록 (meals 서브컬렉션)
      match /meals/{mealId} {
        // 서브컬렉션에서 부모 경로의 userId 변수 참조는 지원되지만, 명시적으로 작성하여 안정성 확보
        allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
        allow create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
      
      // 사용자 설정 (config 서브컬렉션)
      match /config/{configId} {
        // 서브컬렉션에서 부모 경로의 userId 변수 참조는 지원되지만, 명시적으로 작성하여 안정성 확보
        allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
        allow create, update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // ============================================
    // 공유 사진 (sharedPhotos 컬렉션)
    // ============================================
    // 보안 강화: create는 Cloud Functions를 통해서만 허용 (레이트 리밋 및 스팸 필터 적용)
    match /artifacts/{appId}/sharedPhotos/{photoId} {
      allow read: if isAuthenticated();
      // create는 Cloud Functions를 통해서만 허용 (클라이언트 직접 쓰기 차단)
      allow create: if false;
      allow update: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid && 
                     request.resource.data.userId == request.auth.uid;
      allow delete: if isAdmin() || isOwnerOfResource();
    }
    
    // ============================================
    // 관리자 (admins 컬렉션)
    // ============================================
    match /artifacts/{appId}/admins/{adminId} {
      allow read: if isAdmin() || isOwner(adminId);
      allow write: if false;
    }
    
    // ============================================
    // 게시판 (boardPosts 컬렉션)
    // ============================================
    // 보안 강화: create는 Cloud Functions를 통해서만 허용 (레이트 리밋 및 스팸 필터 적용)
    match /artifacts/{appId}/boardPosts/{postId} {
      allow read: if isAuthenticated();
      // create는 Cloud Functions를 통해서만 허용 (클라이언트 직접 쓰기 차단)
      allow create: if false;
      // 수정/삭제: 관리자 또는 작성자. 조회수(views)·댓글수(comments)만 바꿀 때는 로그인 사용자 허용
      // (Cloud Functions는 admin SDK로 쓰므로 Rules를 우회하여 업데이트 가능)
      allow update: if isAdmin() || isAuthorOfResource() || (
        isAuthenticated() && (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments'])
        )
      );
      allow delete: if isAdmin() || isAuthorOfResource();
    }
    
    // ============================================
    // 게시판 상호작용 (boardInteractions 컬렉션)
    // ============================================
    match /artifacts/{appId}/boardInteractions/{interactionId} {
      allow read: if isAuthenticated();
      allow create: if isOwnerOfRequestResource();
      allow update: if isOwnerOfResource();
      allow delete: if isOwnerOfResource();
    }
    
    // ============================================
    // 게시판 댓글 (boardComments 컬렉션)
    // ============================================
    // 보안 강화: create는 Cloud Functions를 통해서만 허용 (레이트 리밋 및 스팸 필터 적용)
    match /artifacts/{appId}/boardComments/{commentId} {
      allow read: if isAuthenticated();
      // create는 Cloud Functions를 통해서만 허용 (클라이언트 직접 쓰기 차단)
      allow create: if false;
      allow update: if isAuthorOfResource();
      allow delete: if isAdmin() || isAuthorOfResource();
    }
    
    // ============================================
    // 게시판 사용자 (boardUsers 컬렉션)
    // ============================================
    match /artifacts/{appId}/boardUsers/{userId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ============================================
    // 피드 좋아요 (postLikes 컬렉션)
    // ============================================
    match /artifacts/{appId}/postLikes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isOwnerOfRequestResource();
      allow update: if false;
      allow delete: if isOwnerOfResource();
    }
    
    // ============================================
    // 피드 북마크 (postBookmarks 컬렉션)
    // ============================================
    match /artifacts/{appId}/postBookmarks/{bookmarkId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isOwnerOfRequestResource();
      allow update: if false;
      allow delete: if isOwnerOfResource();
    }
    
    // ============================================
    // 피드 댓글 (postComments 컬렉션)
    // ============================================
    // 보안 강화: create는 Cloud Functions를 통해서만 허용 (레이트 리밋 및 스팸 필터 적용)
    match /artifacts/{appId}/postComments/{commentId} {
      allow read: if isAuthenticated();
      // create는 Cloud Functions를 통해서만 허용 (클라이언트 직접 쓰기 차단)
      allow create: if false;
      allow update: if isOwnerOfResource();
      allow delete: if isOwnerOfResource();
    }
    
    // ============================================
    // 게시물 신고 (postReports 컬렉션)
    // ============================================
    // 보안 강화: create는 Cloud Functions를 통해서만 허용 (레이트 리밋 및 중복 신고 방지)
    match /artifacts/{appId}/postReports/{reportId} {
      allow read: if isAdmin();
      // create는 Cloud Functions를 통해서만 허용 (클라이언트 직접 쓰기 차단)
      allow create: if false;
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // 공지사항 (notices 컬렉션) - 관리자 전용
    // ============================================
    match /artifacts/{appId}/notices/{noticeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // 공지 반응 (noticeInteractions 컬렉션) - 좋아요/싫어요
    // ============================================
    match /artifacts/{appId}/noticeInteractions/{interactionId} {
      allow read: if isAuthenticated();
      allow create: if isOwnerOfRequestResource();
      allow update: if isOwnerOfResource();
      allow delete: if isOwnerOfResource();
    }
    
    // ============================================
    // 콘텐츠 (content 컬렉션) - 관리자 전용
    // ============================================
    match /artifacts/{appId}/content/{contentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      // 약관 버전 (terms 문서의 하위 컬렉션) - contentId가 'terms'일 때만 매칭
      match /versions/{versionId} {
        // contentId가 'terms'인지 확인
        allow read: if isAuthenticated() && contentId == 'terms';
        allow write: if isAdmin() && contentId == 'terms';
      }
    }
    
    // ============================================
    // 캐릭터 (persona 컬렉션) - 관리자 전용
    // ============================================
    match /artifacts/{appId}/persona/{personaId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
