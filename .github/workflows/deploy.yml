name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create config.js from Secrets
        run: |
          echo "// Gemini API ì„¤ì •" > js/config.js
          echo "// ì´ íŒŒì¼ì€ GitHub Actionsì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤." >> js/config.js
          echo "// API í‚¤ëŠ” GitHub Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤." >> js/config.js
          echo "export const GEMINI_API_KEY = '${{ secrets.GEMINI_API_KEY }}';" >> js/config.js
          echo "ìƒì„±ëœ config.js íŒŒì¼ í™•ì¸:" >> $GITHUB_STEP_SUMMARY
          cat js/config.js | sed 's/AIzaSy[^'"'"']*/AIzaSy***/' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Verify config.js exists
        run: |
          if [ ! -f js/config.js ]; then
            echo "âŒ js/config.js íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          if [ ! -s js/config.js ]; then
            echo "âŒ js/config.js íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… js/config.js íŒŒì¼ ìƒì„± í™•ì¸ë¨"
          ls -la js/config.js
          echo ""
          echo "ğŸ“„ config.js ë‚´ìš© (API í‚¤ ë§ˆìŠ¤í‚¹):"
          cat js/config.js | sed 's/AIzaSy[^'"'"']*/AIzaSy***/'
        shell: bash

      - name: Verify required files
        run: |
          echo "ğŸ“‹ í•„ìˆ˜ íŒŒì¼ í™•ì¸:"
          files=("index.html" "manifest.json" "sw.js" "js/config.js" "js/config.default.js")
          missing_files=()
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file ì¡´ì¬"
            else
              echo "âŒ $file ì—†ìŒ!"
              missing_files+=("$file")
            fi
          done
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ ëˆ„ë½ëœ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤: ${missing_files[*]}"
            exit 1
          fi
        shell: bash

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: List files before upload
        run: |
          echo "ğŸ“ ë°°í¬í•  íŒŒì¼ ëª©ë¡:"
          ls -la
          echo ""
          echo "ğŸ“ js ë””ë ‰í† ë¦¬:"
          ls -la js/ | grep -E "(config|\.js)"
          echo ""
          echo "ğŸ“„ config.js ë‚´ìš© í™•ì¸ (API í‚¤ ë§ˆìŠ¤í‚¹):"
          if [ -f js/config.js ]; then
            cat js/config.js | sed 's/AIzaSy[^'"'"']*/AIzaSy***/'
            echo ""
            echo "âœ… config.js íŒŒì¼ í¬ê¸°:"
            wc -c js/config.js
          else
            echo "âŒ js/config.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          # .gitignoreì— ìˆëŠ” íŒŒì¼ë„ í¬í•¨í•˜ë„ë¡ ì„¤ì •
          # config.jsëŠ” workflowì—ì„œ ìƒì„±ë˜ë¯€ë¡œ í¬í•¨ë¨

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

